name: Version Symmetry (PR)

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: write

jobs:
  ensure-symmetry:
    # Cannot push back to forks with default GITHUB_TOKEN.
    if: ${{ !github.event.pull_request.head.repo.fork }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Normalize versions if misaligned
        id: normalize
        shell: bash
        run: |
          set -euo pipefail

          pkg_version=$(node -p "require('./package.json').version")
          lock_version=$(node -p "require('./package-lock.json').version")
          chart_version=$(sed -n 's/^version:[[:space:]]*//p' charts/bewritten/Chart.yaml | head -n1 | tr -d '"')
          chart_app_version=$(sed -n 's/^appVersion:[[:space:]]*//p' charts/bewritten/Chart.yaml | head -n1 | tr -d '"')
          values_image_tag=$(sed -n '/^image:/,/^service:/ s/^[[:space:]]*#\\?[[:space:]]*tag:[[:space:]]*//p' charts/bewritten/values.yaml | head -n1 | tr -d '"')
          version_file=$(tr -d '[:space:]' < VERSION)

          echo "Current versions:"
          echo "package.json:      $pkg_version"
          echo "package-lock.json: $lock_version"
          echo "Chart version:     $chart_version"
          echo "Chart appVersion:  $chart_app_version"
          echo "values.image.tag:  $values_image_tag"
          echo "VERSION file:      $version_file"

          node <<'NODE'
          const fs = require('fs');

          const semverRe = /^\d+\.\d+\.\d+$/;
          const read = (p) => fs.readFileSync(p, 'utf8');
          const trim = (s) => String(s || '').trim();

          const pkg = JSON.parse(read('package.json'));
          const lock = JSON.parse(read('package-lock.json'));
          const chart = read('charts/bewritten/Chart.yaml');
          const values = read('charts/bewritten/values.yaml');
          const versionFile = trim(read('VERSION'));

          const chartVersion = (chart.match(/^version:\s*"?([^"\n]+)"?\s*$/m) || [])[1];
          const chartAppVersion = (chart.match(/^appVersion:\s*"?([^"\n]+)"?\s*$/m) || [])[1];
          const valuesTagMatch = values.match(/^image:\s*[\r\n]+(?:[^\n]*\n)*?\s*#?\s*tag:\s*"?([^"\n]+)"?/m);
          const valuesImageTag = valuesTagMatch ? valuesTagMatch[1] : '';

          const versions = [
            ['package.json', pkg.version],
            ['package-lock.json', lock.version],
            ['Chart.version', chartVersion],
            ['Chart.appVersion', chartAppVersion],
            ['values.image.tag', valuesImageTag],
            ['VERSION', versionFile],
          ];

          for (const [name, v] of versions) {
            if (name === 'values.image.tag' && String(v || '').trim() === '') {
              continue;
            }
            if (!semverRe.test(String(v || ''))) {
              throw new Error(`Invalid semver in ${name}: ${v}`);
            }
          }

          const allEqual = versions.every(([, v]) => v === versions[0][1]);
          if (allEqual) {
            console.log('Versions already aligned.');
            fs.writeFileSync(process.env.GITHUB_OUTPUT, 'changed=false\n', { flag: 'a' });
            process.exit(0);
          }

          const parse = (v) => v.split('.').map((n) => Number(n));
          const cmp = (a, b) => {
            for (let i = 0; i < 3; i += 1) {
              if (a[i] !== b[i]) return a[i] - b[i];
            }
            return 0;
          };

          const parsed = versions
            .map(([, v]) => String(v || '').trim())
            .filter((v) => semverRe.test(v))
            .map((v) => parse(v));
          const max = parsed.reduce((m, p) => (cmp(p, m) > 0 ? p : m), parsed[0]);
          const next = `${max[0]}.${max[1]}.${max[2] + 1}`;

          console.log(`Misalignment detected. Bumping all version sources to ${next}`);

          pkg.version = next;
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');

          lock.version = next;
          if (lock.packages && lock.packages['']) {
            lock.packages[''].version = next;
          }
          fs.writeFileSync('package-lock.json', JSON.stringify(lock, null, 2) + '\n');

          const updatedChart = chart
            .replace(/^version:\s*"?[^"\n]+"?\s*$/m, `version: ${next}`)
            .replace(/^appVersion:\s*"?[^"\n]+"?\s*$/m, `appVersion: "${next}"`);
          fs.writeFileSync('charts/bewritten/Chart.yaml', updatedChart);

          const updatedValues = values.replace(
            /^image:\s*[\r\n]+((?:[^\n]*\n)*?)(\s*#?\s*tag:\s*"?[^"\n]+"?\s*)/m,
            (full, block) => `image:\n${block.replace(/\n$/, '')}\n  tag: "${next}"\n`
          );
          fs.writeFileSync('charts/bewritten/values.yaml', updatedValues);

          fs.writeFileSync('VERSION', `${next}\n`);

          fs.writeFileSync(process.env.GITHUB_OUTPUT, `changed=true\nnew_version=${next}\n`, { flag: 'a' });
          NODE

      - name: Commit and push
        if: steps.normalize.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json charts/bewritten/Chart.yaml charts/bewritten/values.yaml VERSION
          git commit -m "chore: align versions to ${{ steps.normalize.outputs.new_version }} [skip ci]"
          git push
